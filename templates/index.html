<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Social Disengagement Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#FAFAFA;--card:#FFFFFF;--muted:#F1F5F9;--fg:#0F172A;--sub:#64748B;
  --border:#E2E8F0;--accent:#0052FF;
  --red:#EF4444;--red-bg:#FEF2F2;
  --green:#10B981;--green-bg:#ECFDF5;
  --amber:#F59E0B;--amber-bg:#FFFBEB;
  --grad:linear-gradient(135deg,#0052FF,#4D7CFF);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--fg);font-family:'Inter',sans-serif;min-height:100vh;display:flex;flex-direction:column;}

@keyframes pulse{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(1.5);opacity:.5;}}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}

/* HEADER */
header{
  background:var(--card);border-bottom:1px solid var(--border);
  padding:0 28px;height:60px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 4px rgba(0,0,0,.06);flex-shrink:0;
}
.logo{display:flex;align-items:center;gap:10px;}
.logo-icon{
  width:36px;height:36px;border-radius:10px;background:var(--grad);
  display:flex;align-items:center;justify-content:center;font-size:17px;
  box-shadow:0 4px 12px rgba(0,82,255,.25);animation:float 4s ease-in-out infinite;
}
.logo-name{font-size:17px;font-weight:700;color:var(--fg);}
.live-pill{
  display:flex;align-items:center;gap:8px;
  border:1px solid rgba(16,185,129,.3);background:var(--green-bg);
  border-radius:999px;padding:5px 14px;font-size:11px;font-weight:600;color:var(--green);
}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s ease-in-out infinite;}
.clock{font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--sub);}

/* PAGE LAYOUT
   Left:  camera feed (big, ~65% width)
   Right: stats on top + task panel below (~35% width)
*/
.page{
  flex:1;
  display:grid;
  grid-template-columns:1fr 360px;
  grid-template-rows:1fr;
  gap:18px;
  padding:18px 24px;
  min-height:0;
}

/* RIGHT COLUMN stacks stats on top, tasks below */
.right-col{
  display:flex;
  flex-direction:column;
  gap:16px;
  min-height:0;
}

.stats-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
  flex-shrink:0;
}

/* STAT CARDS */
.stat-card{
  background:var(--card);border:1px solid var(--border);border-radius:16px;
  padding:18px 16px;box-shadow:0 2px 8px rgba(0,0,0,.06);
  display:flex;flex-direction:column;justify-content:space-between;
  position:relative;overflow:hidden;
}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:16px 16px 0 0;}
.stat-card.blue::before{background:var(--grad);}
.stat-card.red::before{background:linear-gradient(90deg,var(--red),#FF8A8A);}
.stat-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);margin-bottom:6px;}
.stat-num{font-size:52px;font-weight:800;line-height:1;letter-spacing:-2px;}
.stat-num.blue{background:var(--grad);-webkit-background-clip:text;background-clip:text;color:transparent;}
.stat-num.red{color:var(--red);}
.stat-foot{font-size:10px;color:var(--sub);margin-top:6px;line-height:1.4;}

/* CAMERA CARD ‚Äî fills entire left column */
.feed-card{
  background:var(--card);border:1px solid var(--border);border-radius:18px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);overflow:hidden;
  display:flex;flex-direction:column;
  min-height:0;
}
.feed-header{
  padding:12px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;
  flex-shrink:0;
}
.feed-title{font-size:13px;font-weight:700;}
.feed-legend{display:flex;align-items:center;gap:12px;font-size:11px;color:var(--sub);}
.leg{display:flex;align-items:center;gap:5px;}
.leg-dot{width:8px;height:8px;border-radius:50%;}

.feed-body{
  flex:1;background:#0d0d0d;position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  min-height:0;
}
#cam-placeholder{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:12px;color:#555;font-size:14px;font-weight:500;
  position:absolute;inset:0;z-index:1;
}
#cam-stream{
  width:100%;height:100%;object-fit:contain;
  display:none;position:relative;z-index:2;
}

.feed-controls{
  padding:10px 16px;border-top:1px solid var(--border);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  flex-shrink:0;
}
.btn-start{
  padding:7px 18px;border-radius:999px;border:none;
  background:var(--grad);color:#fff;font-size:12px;font-weight:600;
  cursor:pointer;font-family:inherit;box-shadow:0 2px 8px rgba(0,82,255,.3);transition:opacity .2s;
}
.btn-stop{
  padding:7px 18px;border-radius:999px;
  border:1.5px solid var(--border);background:transparent;
  color:var(--sub);font-size:12px;font-weight:600;
  cursor:pointer;font-family:inherit;transition:opacity .2s;opacity:.5;
}
.slider-wrap{display:flex;align-items:center;gap:8px;margin-left:auto;}
.slider-label{font-size:10px;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;}
#distance-slider{width:100px;accent-color:var(--accent);cursor:pointer;}
#distance-value{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--accent);font-weight:600;min-width:38px;}

/* TASK PANEL */
.task-card{
  background:var(--card);border:1px solid var(--border);border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden;
  display:flex;flex-direction:column;
  flex:1;min-height:0;
}
.task-header{
  padding:12px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.task-title{font-size:13px;font-weight:700;}
.task-badge{font-size:10px;font-weight:600;padding:3px 10px;border-radius:999px;transition:all .3s;}
.task-badge.zero{background:var(--green-bg);color:var(--green);border:1px solid rgba(16,185,129,.3);}
.task-badge.alert{background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,.3);}

.task-body{flex:1;overflow-y:auto;}

.no-task{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:30px 20px;gap:10px;text-align:center;
}
.no-task .emo{font-size:36px;}
.no-task h3{font-size:14px;font-weight:700;}
.no-task p{font-size:12px;color:var(--sub);line-height:1.6;}

.person-block{padding:14px 18px;border-bottom:1px solid var(--border);animation:slideIn .3s ease;}
.person-head{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.person-icon{width:38px;height:38px;border-radius:10px;background:var(--red-bg);display:flex;align-items:center;justify-content:center;font-size:19px;border:1px solid rgba(239,68,68,.15);flex-shrink:0;}
.person-name{font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;}
.iso-badge{font-size:9px;font-weight:700;background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,.3);padding:2px 7px;border-radius:999px;}
.person-time{font-size:11px;color:var(--sub);font-family:'Share Tech Mono',monospace;margin-top:2px;}

.iso-bar{margin-bottom:10px;}
.iso-bar-top{display:flex;justify-content:space-between;font-size:10px;color:var(--sub);margin-bottom:4px;}
.iso-track{height:5px;background:var(--muted);border-radius:999px;overflow:hidden;}
.iso-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--amber),var(--red));transition:width .6s ease;}

.task-list{display:flex;flex-direction:column;gap:6px;}
.task-item{
  display:flex;align-items:flex-start;gap:9px;
  background:var(--muted);border:1px solid var(--border);
  border-radius:10px;padding:9px 11px;
}
.t-icon{font-size:16px;flex-shrink:0;margin-top:1px;}
.t-text{font-size:12px;font-weight:500;line-height:1.4;color:var(--fg);}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üëÅ</div>
    <div class="logo-name">NoOneLeftAlone.exe</div>
  </div>
  <div class="live-pill"><div class="live-dot"></div>Live Detection</div>
  <div class="clock" id="clock">00:00:00</div>
</header>

<div class="page">

  <!-- LEFT: BIG CAMERA FEED -->
  <div class="feed-card">
    <div class="feed-header">
      <div class="feed-title">üìπ Live Camera Feed</div>
      <div class="feed-legend">
        <div class="leg"><div class="leg-dot" style="background:var(--green)"></div>Engaged</div>
        <div class="leg"><div class="leg-dot" style="background:var(--amber)"></div>Watching</div>
        <div class="leg"><div class="leg-dot" style="background:var(--red)"></div>Isolated</div>
      </div>
    </div>
    <div class="feed-body">
      <div id="cam-placeholder">
        <div style="font-size:48px">üì∑</div>
        <div>Click <strong style="color:var(--accent)">Start Camera</strong> to begin detection</div>
      </div>
      <img id="cam-stream" src="" alt="camera feed">
    </div>
    <div class="feed-controls">
      <button class="btn-start" id="btn-start">‚ñ∂ Start Camera</button>
      <button class="btn-stop"  id="btn-stop">‚èπ Stop Camera</button>
      <div class="slider-wrap">
        <span class="slider-label">Threshold</span>
        <input type="range" id="distance-slider" min="50" max="500" value="200">
        <span id="distance-value">200px</span>
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div class="right-col">

    <!-- Stats row -->
    <div class="stats-row">
      <div class="stat-card blue">
        <div class="stat-label">Total People</div>
        <div class="stat-num blue" id="total">0</div>
        <div class="stat-foot">Currently in frame</div>
      </div>
      <div class="stat-card red">
        <div class="stat-label">Isolated</div>
        <div class="stat-num red" id="iso">0</div>
        <div class="stat-foot" id="iso-foot">No one isolated</div>
      </div>
    </div>

    <!-- Task panel -->
    <div class="task-card">
      <div class="task-header">
        <div class="task-title">üéØ Re-Engagement Tasks</div>
        <div class="task-badge zero" id="task-badge">All Clear</div>
      </div>
      <div class="task-body" id="task-body">
        <div class="no-task">
          <div class="emo">‚úÖ</div>
          <h3>Everyone is engaged!</h3>
          <p>Tasks appear automatically when someone is isolated for more than 20 seconds.</p>
        </div>
      </div>
    </div>

  </div><!-- end right-col -->

</div><!-- end page -->

<script>
const ICONS = ['üëã','üé§','‚òï','üÉè','üì∏','ü§ù','üéØ','üí¨','üåü','üé≤'];

/* Clock */
function tick(){ document.getElementById('clock').textContent = new Date().toTimeString().slice(0,8); }
setInterval(tick,1000); tick();

/* Camera controls */
document.getElementById('btn-start').addEventListener('click', async () => {
  try {
    await fetch('/start_camera', {method:'POST'});
    const img = document.getElementById('cam-stream');
    img.src = '/video';
    img.style.display = 'block';
    document.getElementById('cam-placeholder').style.display = 'none';
    document.getElementById('btn-start').style.opacity = '0.5';
    document.getElementById('btn-stop').style.opacity  = '1';
  } catch(e){ console.error(e); }
});

document.getElementById('btn-stop').addEventListener('click', async () => {
  try {
    await fetch('/stop_camera', {method:'POST'});
    const img = document.getElementById('cam-stream');
    img.src = '';
    img.style.display = 'none';
    document.getElementById('cam-placeholder').style.display = 'flex';
    document.getElementById('btn-start').style.opacity = '1';
    document.getElementById('btn-stop').style.opacity  = '0.5';
    setStats(0, 0);
    setTaskPanel([]);
  } catch(e){ console.error(e); }
});

document.getElementById('distance-slider').addEventListener('input', async (e) => {
  const val = parseInt(e.target.value);
  document.getElementById('distance-value').textContent = val + 'px';
  try {
    await fetch('/set_distance', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({distance: val})
    });
  } catch(e){ console.error(e); }
});

/* Poll /stats every second */
setInterval(async () => {
  try {
    const res  = await fetch('/stats');
    if (!res.ok) return;
    const data = await res.json();
    setStats(data.total || 0, data.isolated || 0);
    setTaskPanel(data.persons || []);
  } catch(e){}
}, 1000);

function setStats(total, iso) {
  document.getElementById('total').textContent = total;
  const isoEl = document.getElementById('iso');
  isoEl.textContent = iso;
  isoEl.style.color  = iso > 0 ? 'var(--red)' : 'var(--green)';
  document.getElementById('iso-foot').textContent = iso
    ? `${iso} person${iso > 1 ? 's' : ''} alone >20s`
    : 'No one isolated right now ‚úì';

  const badge = document.getElementById('task-badge');
  if (iso > 0) {
    badge.textContent  = iso + ' Alert' + (iso > 1 ? 's' : '');
    badge.className = 'task-badge alert';
  } else {
    badge.textContent = 'All Clear';
    badge.className = 'task-badge zero';
  }
}

function setTaskPanel(persons) {
  const body = document.getElementById('task-body');
  const isolated = persons.filter(p => p.status === 'isolated' && p.tasks && p.tasks.length);
  if (!isolated.length) {
    body.innerHTML = `<div class="no-task">
      <div class="emo">‚úÖ</div>
      <h3>Everyone is engaged!</h3>
      <p>Tasks appear automatically when someone is isolated for more than 20 seconds.</p>
    </div>`;
    return;
  }
  body.innerHTML = isolated.map(p => {
    const pct   = Math.min((p.elapsed / 20) * 100, 100);
    const items = p.tasks.map((t,i) => `
      <div class="task-item">
        <div class="t-icon">${ICONS[i % ICONS.length]}</div>
        <div class="t-text">${t}</div>
      </div>`).join('');
    return `<div class="person-block">
      <div class="person-head">
        <div class="person-icon">üßç</div>
        <div>
          <div class="person-name">${p.id} <span class="iso-badge">Isolated</span></div>
          <div class="person-time">Alone for ${Math.floor(p.elapsed)}s</div>
        </div>
      </div>
      <div class="iso-bar">
        <div class="iso-bar-top"><span>Isolation time</span><span>${Math.floor(p.elapsed)}s / 20s</span></div>
        <div class="iso-track"><div class="iso-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="task-list">${items}</div>
    </div>`;
  }).join('');
}
</script>
</body>
</html>