<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Social Disengagement Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#FAFAFA;--card:#FFFFFF;--muted:#F1F5F9;--fg:#0F172A;--sub:#64748B;
  --border:#E2E8F0;--accent:#0052FF;--accent2:#4D7CFF;
  --red:#EF4444;--red-bg:#FEF2F2;
  --green:#10B981;--green-bg:#ECFDF5;
  --amber:#F59E0B;--amber-bg:#FFFBEB;
  --grad:linear-gradient(135deg,#0052FF,#4D7CFF);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--fg);font-family:'Inter',sans-serif;min-height:100vh;display:flex;flex-direction:column;}

@keyframes pulse{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(1.5);opacity:.5;}}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
@keyframes redglow{0%,100%{box-shadow:0 0 0 4px rgba(239,68,68,.1);}50%{box-shadow:0 0 0 10px rgba(239,68,68,.2);}}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{
  background:var(--card);border-bottom:1px solid var(--border);
  padding:0 32px;height:64px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 4px rgba(0,0,0,.06);
}
.logo{display:flex;align-items:center;gap:12px;}
.logo-icon{
  width:38px;height:38px;border-radius:11px;background:var(--grad);
  display:flex;align-items:center;justify-content:center;font-size:18px;
  box-shadow:0 4px 12px rgba(0,82,255,.25);animation:float 4s ease-in-out infinite;
}
.logo-name{font-size:18px;font-weight:700;color:var(--fg);}
.live-pill{
  display:flex;align-items:center;gap:8px;
  border:1px solid rgba(16,185,129,.3);background:var(--green-bg);
  border-radius:999px;padding:6px 16px;font-size:12px;font-weight:600;color:var(--green);
}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s ease-in-out infinite;}
.clock{font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--sub);}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ
   Col 1 & 2: stat cards (narrow)
   Col 3: camera (wide ‚Äî takes most space)
   Col 4: task panel
*/
.page{
  flex:1;padding:24px 32px;
  display:grid;
  grid-template-columns:150px 150px 1fr 340px;
  grid-template-rows:auto 1fr;
  gap:18px;
}

/* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
.stat-card{
  background:var(--card);border:1px solid var(--border);border-radius:18px;
  padding:22px 18px;box-shadow:0 2px 10px rgba(0,0,0,.06);
  display:flex;flex-direction:column;justify-content:space-between;
  position:relative;overflow:hidden;
}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:18px 18px 0 0;}
.stat-card.blue::before{background:var(--grad);}
.stat-card.red::before{background:linear-gradient(90deg,var(--red),#FF8A8A);}
.stat-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);margin-bottom:8px;}
.stat-num{font-size:56px;font-weight:800;line-height:1;letter-spacing:-2px;}
.stat-num.blue{background:var(--grad);-webkit-background-clip:text;background-clip:text;color:transparent;}
.stat-num.red{color:var(--red);}
.stat-foot{font-size:11px;color:var(--sub);margin-top:8px;line-height:1.4;}

/* ‚îÄ‚îÄ CAMERA CARD ‚îÄ‚îÄ */
.feed-card{
  background:var(--card);border:1px solid var(--border);border-radius:18px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);overflow:hidden;
  display:flex;flex-direction:column;
  grid-row:1/3;
}
.feed-header{
  padding:12px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;
}
.feed-title{font-size:13px;font-weight:700;}
.feed-legend{display:flex;align-items:center;gap:12px;font-size:11px;color:var(--sub);}
.leg{display:flex;align-items:center;gap:5px;}
.leg-dot{width:8px;height:8px;border-radius:50%;}

.feed-body{
  flex:1;background:#0d0d0d;position:relative;overflow:hidden;min-height:260px;
  display:flex;align-items:center;justify-content:center;
}
#cam-placeholder{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;color:#444;font-size:13px;font-weight:500;
  position:absolute;inset:0;z-index:1;
}
#cam-stream{
  width:100%;height:100%;object-fit:contain;
  display:none;position:relative;z-index:2;
}

.feed-controls{
  padding:12px 18px;border-top:1px solid var(--border);
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;background:var(--card);
}
.btn-start{
  padding:8px 20px;border-radius:999px;border:none;
  background:var(--grad);color:#fff;font-size:12px;font-weight:600;
  cursor:pointer;font-family:inherit;box-shadow:0 2px 8px rgba(0,82,255,.3);
  transition:all .2s;
}
.btn-stop{
  padding:8px 20px;border-radius:999px;
  border:1.5px solid var(--border);background:transparent;
  color:var(--sub);font-size:12px;font-weight:600;
  cursor:pointer;font-family:inherit;transition:all .2s;opacity:.5;
}
.slider-wrap{display:flex;align-items:center;gap:10px;margin-left:auto;}
.slider-label{font-size:11px;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;}
#distance-slider{width:120px;accent-color:var(--accent);cursor:pointer;}
#distance-value{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--accent);font-weight:600;min-width:44px;}

/* ‚îÄ‚îÄ TASK PANEL ‚îÄ‚îÄ */
.task-card{
  background:var(--card);border:1px solid var(--border);border-radius:18px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);overflow:hidden;
  display:flex;flex-direction:column;grid-row:1/3;
}
.task-header{
  padding:14px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.task-title{font-size:14px;font-weight:700;}
.task-badge{font-size:11px;font-weight:600;padding:3px 12px;border-radius:999px;transition:all .3s;}
.task-badge.zero{background:var(--green-bg);color:var(--green);border:1px solid rgba(16,185,129,.3);}
.task-badge.alert{background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,.3);}

.task-body{flex:1;overflow-y:auto;}
.no-task{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:40px 24px;gap:12px;text-align:center;min-height:200px;
}
.no-task .emo{font-size:40px;}
.no-task h3{font-size:15px;font-weight:700;}
.no-task p{font-size:13px;color:var(--sub);line-height:1.6;}

.person-block{padding:16px 20px;border-bottom:1px solid var(--border);animation:slideIn .3s ease;}
.person-head{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.person-icon{width:40px;height:40px;border-radius:11px;background:var(--red-bg);display:flex;align-items:center;justify-content:center;font-size:20px;border:1px solid rgba(239,68,68,.15);}
.person-name{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
.iso-badge{font-size:10px;font-weight:600;background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,.3);padding:2px 8px;border-radius:999px;}
.person-time{font-size:11px;color:var(--sub);font-family:'Share Tech Mono',monospace;margin-top:2px;}

.iso-bar{margin-bottom:12px;}
.iso-bar-top{display:flex;justify-content:space-between;font-size:11px;color:var(--sub);margin-bottom:4px;}
.iso-track{height:6px;background:var(--muted);border-radius:999px;overflow:hidden;}
.iso-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--amber),var(--red));transition:width .6s ease;}

.task-list{display:flex;flex-direction:column;gap:8px;}
.task-item{
  display:flex;align-items:flex-start;gap:10px;
  background:var(--muted);border:1px solid var(--border);
  border-radius:11px;padding:10px 12px;
}
.t-icon{font-size:17px;flex-shrink:0;margin-top:1px;}
.t-text{font-size:12px;font-weight:500;line-height:1.4;color:var(--fg);}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
::-webkit-scrollbar-thumb:hover{background:var(--accent);}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üëÅ</div>
    <div class="logo-name">NoOneLeftAlone.exe</div>
  </div>
  <div class="live-pill"><div class="live-dot"></div>Live Detection</div>
  <div class="clock" id="clock">00:00:00</div>
</header>

<div class="page">

  <!-- STAT: Total People -->
  <div class="stat-card blue">
    <div class="stat-label">Total People</div>
    <div class="stat-num blue" id="total">0</div>
    <div class="stat-foot">Currently in frame</div>
  </div>

  <!-- STAT: Isolated -->
  <div class="stat-card red">
    <div class="stat-label">Isolated</div>
    <div class="stat-num red" id="iso">0</div>
    <div class="stat-foot" id="iso-foot">No one isolated</div>
  </div>

  <!-- CAMERA FEED -->
  <div class="feed-card">
    <div class="feed-header">
      <div class="feed-title">üìπ Live Camera Feed</div>
      <div class="feed-legend">
        <div class="leg"><div class="leg-dot" style="background:var(--green)"></div>Engaged</div>
        <div class="leg"><div class="leg-dot" style="background:var(--amber)"></div>Watching</div>
        <div class="leg"><div class="leg-dot" style="background:var(--red)"></div>Isolated</div>
      </div>
    </div>
    <div class="feed-body">
      <div id="cam-placeholder">
        <div style="font-size:44px">üì∑</div>
        <div>Click <strong style="color:var(--accent)">Start Camera</strong> to begin</div>
      </div>
      <img id="cam-stream" src="" alt="camera">
    </div>
    <div class="feed-controls">
      <button class="btn-start" id="btn-start">‚ñ∂ Start Camera</button>
      <button class="btn-stop" id="btn-stop">‚èπ Stop Camera</button>
      <div class="slider-wrap">
        <span class="slider-label">Distance Threshold</span>
        <input type="range" id="distance-slider" min="50" max="500" value="200">
        <span id="distance-value">200px</span>
      </div>
    </div>
  </div>

  <!-- TASK PANEL -->
  <div class="task-card">
    <div class="task-header">
      <div class="task-title">üéØ Re-Engagement Tasks</div>
      <div class="task-badge zero" id="task-badge">All Clear</div>
    </div>
    <div class="task-body" id="task-body">
      <div class="no-task">
        <div class="emo">‚úÖ</div>
        <h3>Everyone is engaged!</h3>
        <p>Tasks appear automatically when someone is isolated for more than 20 seconds.</p>
      </div>
    </div>
  </div>

</div>

<script>
const ICONS = ['üëã','üé§','‚òï','üÉè','üì∏','ü§ù','üéØ','üí¨','üåü','üé≤'];

/* ‚îÄ‚îÄ Clock ‚îÄ‚îÄ */
function tick(){ document.getElementById('clock').textContent = new Date().toTimeString().slice(0,8); }
setInterval(tick, 1000); tick();

/* ‚îÄ‚îÄ Camera controls ‚îÄ‚îÄ */
document.getElementById('btn-start').addEventListener('click', async () => {
  await fetch('/start_camera', { method: 'POST' });
  document.getElementById('cam-stream').src = '/video';
  document.getElementById('cam-stream').style.display = 'block';
  document.getElementById('cam-placeholder').style.display = 'none';
  document.getElementById('btn-start').style.opacity = '0.5';
  document.getElementById('btn-stop').style.opacity = '1';
});

document.getElementById('btn-stop').addEventListener('click', async () => {
  await fetch('/stop_camera', { method: 'POST' });
  document.getElementById('cam-stream').src = '';
  document.getElementById('cam-stream').style.display = 'none';
  document.getElementById('cam-placeholder').style.display = 'flex';
  document.getElementById('btn-start').style.opacity = '1';
  document.getElementById('btn-stop').style.opacity = '0.5';
  document.getElementById('total').textContent = '0';
  document.getElementById('iso').textContent = '0';
  document.getElementById('iso-foot').textContent = 'No one isolated';
  document.getElementById('task-badge').textContent = 'All Clear';
  document.getElementById('task-badge').className = 'task-badge zero';
  document.getElementById('task-body').innerHTML = noTaskHTML('Camera stopped', 'Start the camera to begin detection.');
});

document.getElementById('distance-slider').addEventListener('input', async (e) => {
  const val = parseInt(e.target.value);
  document.getElementById('distance-value').textContent = val + 'px';
  await fetch('/set_distance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ distance: val })
  });
});

/* ‚îÄ‚îÄ Poll /stats every second ‚îÄ‚îÄ */
setInterval(pollStats, 1000);

async function pollStats() {
  let data;
  try {
    const res = await fetch('/stats');
    if (!res.ok) return;
    data = await res.json();
  } catch(e) { return; }

  /* Stat cards */
  document.getElementById('total').textContent = data.total || 0;
  const isoCount = data.isolated || 0;
  const isoEl = document.getElementById('iso');
  isoEl.textContent = isoCount;
  isoEl.style.color = isoCount > 0 ? 'var(--red)' : 'var(--green)';
  document.getElementById('iso-foot').textContent = isoCount
    ? `${isoCount} person${isoCount > 1 ? 's' : ''} alone >20s`
    : 'No one isolated right now ‚úì';

  /* Badge */
  const badge = document.getElementById('task-badge');
  if (isoCount > 0) {
    badge.textContent = isoCount + ' Alert' + (isoCount > 1 ? 's' : '');
    badge.className = 'task-badge alert';
  } else {
    badge.textContent = 'All Clear';
    badge.className = 'task-badge zero';
  }

  /* Task panel */
  renderTasks(data.persons || []);
}

function noTaskHTML(title, msg) {
  return `<div class="no-task"><div class="emo">‚úÖ</div><h3>${title}</h3><p>${msg}</p></div>`;
}

function renderTasks(persons) {
  const body = document.getElementById('task-body');
  const isolated = persons.filter(p => p.status === 'isolated' && p.tasks && p.tasks.length);

  if (!isolated.length) {
    body.innerHTML = noTaskHTML('Everyone is engaged!', 'Tasks appear automatically when someone is isolated for more than 20 seconds.');
    return;
  }

  body.innerHTML = isolated.map(p => {
    const pct = Math.min((p.elapsed / 20) * 100, 100);
    const taskItems = p.tasks.map((t, i) => `
      <div class="task-item">
        <div class="t-icon">${ICONS[i % ICONS.length]}</div>
        <div class="t-text">${t}</div>
      </div>`).join('');

    return `
      <div class="person-block">
        <div class="person-head">
          <div class="person-icon">üßç</div>
          <div>
            <div class="person-name">${p.id} <span class="iso-badge">Isolated</span></div>
            <div class="person-time">Alone for ${Math.floor(p.elapsed)}s</div>
          </div>
        </div>
        <div class="iso-bar">
          <div class="iso-bar-top"><span>Isolation time</span><span>${Math.floor(p.elapsed)}s / 20s</span></div>
          <div class="iso-track"><div class="iso-fill" style="width:${pct}%"></div></div>
        </div>
        <div class="task-list">${taskItems}</div>
      </div>`;
  }).join('');
}
</script>
</body>
</html>
